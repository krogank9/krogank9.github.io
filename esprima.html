<!DOCTYPE html PUBLIC"-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<style>
		textarea{resize: none; scroll: none;}
	</style>
</head>
<body>
	
<h2 style="font-weight: normal;">Convert .js to geany .js.tags format</h2>
Minimum function name length when parsing: <input type="number" id="minFuncLength" style="width: 50px;" min="1" value="3"></input>
<br>
<br><textarea id="source" rows="10" cols="75"></textarea>
<br><input id="uploadSingle" type="file" multiple></input>
<div id="saveDiv" style="display: none;">
	<textarea id="user_input" rows="1" cols="75" placeholder="type function or variable"></textarea>
	<form id="saveForm" action="javascript:void(0);">
		<br><input type="text" id="saveName" value="mylib.js.tags"></input>
		<input type="submit" id="saveButton" value="Save"></input>
		<span>Output should be OK, but have a look and edit it if needed</span>
	</form>
</div>

<script src="esprima.js"></script>
<script src="FileSaver.js"></script>
<script src="recurse_esprima_tree.js"></script>
<script>
	var input = document.getElementById("user_input");
	var source = document.getElementById("source");
	window.addEventListener('DOMContentLoaded', function() {
		source.value = "drag & drop javascript files+folders into this box (Requires Chrome >= v21)\n\nOr, upload files (folders not supported) below";
	});
	/*source.onchange = function(evt) { 
		var tree = esprima.parse(this.value);
		console.log(tree);
		recurse_tree(tree);
	}*/
	input.oninput = function(evt) { makeSuggestions(); };
	function makeSuggestions() {
		if(!functions || functions.length == 0) return;
		source.value = "";
		var text = input.value;
		source.rows = 1;
		if(text.length < 2) return;
		// when typing function parameters, show sub functions
		if(text.indexOf('(') > -1) {
			if(text.indexOf('.') > -1) {
				var dotPos = text.indexOf('.');
				while(dotPos < text.indexOf('(')) {
					var nextDotPos = text.indexOf('.',dotPos+1);
					if(nextDotPos > dotPos && nextDotPos < text.indexOf('(')){
						dotPos = nextDotPos;
					} else break;
				}
				text = text.substring(dotPos+1,text.indexOf('('));
			}
		}
		text = text.replace(/\(.*/,"");
		
		var numSuggests = 0;
		for(var i=0; functions && i<functions.length; i++) {
			if( strInStr(functions[i].name,text,0) ) {
				if(numSuggests>0) source.value += "\n";
				source.value += functions[i].name;
				if(functions[i].params.length > 0) {
					source.value += "(";
					for(var j=0; j<functions[i].params.length; j++) {
						if(j>0) source.value +=	 ", ";
						source.value += functions[i].params[j];
					}
					source.value += ")";
				}
				numSuggests++;
			}
		}
		if(numSuggests<10) source.rows = numSuggests||1;
		else source.rows = 10;
	}
</script>

</body>
</html>
